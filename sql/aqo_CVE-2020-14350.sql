/*
 * Check fix for CVE-2020-14350.
 * See also 7eeb1d986 postgresql commit.
 */

SET client_min_messages = 'warning';
DROP ROLE IF EXISTS regress_hacker;
SET client_min_messages = 'notice';

CREATE ROLE regress_hacker LOGIN;

-- Test 1
RESET ROLE;
ALTER ROLE regress_hacker NOSUPERUSER;

SET ROLE regress_hacker;
SHOW is_superuser;
CREATE FUNCTION format(f text, r regclass, t text)
RETURNS text
AS $$
BEGIN
  ALTER ROLE regress_hacker SUPERUSER;
  RETURN '';
END
$$ LANGUAGE plpgsql RETURNS NULL ON NULL INPUT;

RESET ROLE;
CREATE EXTENSION aqo;

-- Test result (must be 'off')
SET ROLE regress_hacker;
SHOW is_superuser;

RESET ROLE;
DROP FUNCTION format(text, regclass, text);
DROP EXTENSION IF EXISTS aqo;

-- Test 2
RESET ROLE;
ALTER ROLE regress_hacker NOSUPERUSER;

SET ROLE regress_hacker;
SHOW is_superuser;

CREATE FUNCTION aqo_migrate_to_1_1_get_pk(rel text)
RETURNS regclass
AS $$
DECLARE
  ret regclass;
BEGIN
  ALTER ROLE regress_hacker SUPERUSER;
  SELECT * FROM aqo_migrate_to_1_1_get_pk(rel::regclass) INTO ret;
  RETURN ret;
END
$$ LANGUAGE plpgsql;

RESET ROLE;
CREATE EXTENSION aqo;

-- Test result (must be 'off')
SET ROLE regress_hacker;
SHOW is_superuser;

RESET ROLE;
DROP FUNCTION aqo_migrate_to_1_1_get_pk(text);
DROP EXTENSION IF EXISTS aqo;

-- Cleanup
RESET ROLE;
DROP ROLE regress_hacker;

